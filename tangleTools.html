<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Programmed by ifinta -->
  <title>tangleTools</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <style>
  th, td {
      padding: 5px;
  }

  tr.a:nth-child(even) {
    background-color: #ddd;
  }

  tr.b:nth-child(even) {
    background-color: #fff;
  }

  #showtransaction .modal-dialog
  {
    width: 1000px;
  }
  </style>

<body>

</head>

<script>

var work = [];
var bundles = new Map();
var transactions = new Map();

var oldtips = [];
var tips = [];

var worksDid = 0;
var worksTotal = 0;

var toShow = 0;
var numRows = 50;
var showind = toShow;

function sendRequest(requestData, callback) {
  var url = "http://127.0.0.1:14265";
  console.log( "Sending an request to " + url + " with data " + JSON.stringify(requestData) );
  var request = new XMLHttpRequest();
  request.open("POST", url);
  request.onreadystatechange = function() {
    if (this.readyState == 4) {
      var json = JSON.parse(this.responseText);
      if (json.exception) {
        console.log(json.exception);
      } else if (json.error) {
        console.log(json.error);
      } else {
        callback(json);
      }
    }
  };
  request.send(JSON.stringify(requestData));
}

$(document).ready(function(){
    $('.progress-bar').attr('aria-valuemin', 0);
    $('.progress-bar').attr('aria-valuemax', worksTotal);
    $('.progress-bar').attr('aria-valuenow', 0);
    $('.progress-bar').css('width', '0.1%');
    $('#pointer').html(toShow + "/?");

    var getTips = {
        'command': 'getTips'
    }

    sendRequest(getTips, function(data) {
       console.log("Got tx: " + JSON.stringify(data));
       tips = data.hashes;
       var d = new Date();
       $('#status').append("Time: " + d + " worksTotal: " + worksTotal + " worksDid: " + worksDid + " xTips: - newTips: - nTips: " + data.hashes.length + "<br/>");
    });

    $("#play").click( function(e){
      e.preventDefault();

      $('#maintable').html("");

      $.each(transactions, function(m, item) {
        $.each(item, function(n, tx) {
          //if(tx.address == "SZFYCCCVXBFGZBO9EYZCDMVGNKHNCEMLKLTMLPWPLDGXZSJIRIMOXXCTHOPSVGLYZGTIGGNPBWSXOBQGP")
          if(tx.address == "IBCTEUYCNWICK9SVPMHHZHYTIHGIWWQEFJVQSLODG9DRUQZDIAIAJZPPFHOJVVIVBEFDJGHGKKVBNJPVJWOJFYNUIG")
          {
            $('#maintable').append(
              $('<tr class="a">').html('<td>' + showtx(tx.hash,0) + '</td>')
            );
          }
        });
      });

      $('#maintable').append(
        $('<tr class="a">').html('<td>done</td>')
      );

      return false;
    });

    $(".prev").click( function(e){
      e.preventDefault();

      $('#maintable').html("");
      toShow -= numRows;
      if(toShow<0)
        toShow = 0;
      showind = toShow;

      return false;
    });

    $(".next").click( function(e){
      e.preventDefault();

      $('#maintable').html("");
      toShow += numRows;
      if(toShow > bundles.length)
        toShow = bundles.length - numRows;
      showind = toShow;

      return false;
    });

    $(document).on("click", ".tx", function () {

      var getTrytes = {
        'command': 'getTrytes',
        'hashes': []
      }

      getTrytes.hashes.push(this.id);

      sendRequest(getTrytes, function(trytes) {
         console.log("Got tx trytes: " + JSON.stringify(trytes));

         var analyzeTransactions = {
           'command': 'analyzeTransactions',
           'trytes': trytes.trytes
         }

         sendRequest(analyzeTransactions, function(analyze) {
           console.log("Analyze tx trytes: " + JSON.stringify(analyze));
           $("#showtxcontent").text(JSON.stringify(analyze.transactions[0]));
         });
      });
    });

    function showtx(hash, n) {
      var result = '<a href="#showtransaction" data-toggle="modal" class="tx" id="' + hash + '">';
      if(n == 0)
        result = result + hash;
      else
        result = result + hash.substring(0, n) + "...";
      return result + '</a>';
    };

    setInterval(function(){
      if(work.length > 0) {

        var tail = work.shift();

        var knownTx = transactions.has(tail);
        if(!knownTx) {
          var getBundle = {
            'command': 'getBundle',
            'transaction': tail
          }

          sendRequest(getBundle, function(data) {
            console.log("Got bundle: " + JSON.stringify(data));

             var getTrytes = {
               'command': 'getTrytes',
               'hashes': []
             }

             $.each(data.transactions, function(i, item) {
               var knownTx = transactions.has(item.hash);
               if(!knownTx)
                getTrytes.hashes.push(item.hash);
               else
                console.log("known tx... not for analyze: " + item.hash);
             });

             if(getTrytes.hashes.length > 0) {
               bundles.set(getBundle.tail, { 'hashes': getTrytes.hashes });
             } else {
               getTrytes.hashes.push(tail);
             }

             sendRequest(getTrytes, function(trytes) {
                console.log("Got trytes: " + JSON.stringify(trytes));

                var analyzeTransactions = {
                  'command': 'analyzeTransactions',
                  'trytes': trytes.trytes
                }

                sendRequest(analyzeTransactions, function(analyze) {
                  console.log("Analyze trytes: " + JSON.stringify(analyze));

                  $.each(analyze.transactions, function(i, item) {
                    transactions.set(item.hash, item);
                    work.push(item.approvedTrunkTransaction);
                    work.push(item.approvedBranchTransaction);
                    worksTotal+=2;
                  });

                  console.log("unknownn bundle registered....");
                  $('.progress-bar').attr('aria-valuemax', worksTotal);
                  $('.progress-bar').attr('aria-valuenow', ++worksDid);
                  var siz = (worksDid-$('.progress-bar').attr('aria-valuemin'))*100/($('.progress-bar').attr('aria-valuemax') - $('.progress-bar').attr('aria-valuemin'));
                  $('.progress-bar').css('width', siz+'%');
                });
             });
          });
        } else {
          console.log("known tail... dropped: " + tail);
          $('.progress-bar').attr('aria-valuenow', ++worksDid);
          var siz = (worksDid-$('.progress-bar').attr('aria-valuemin'))*100/($('.progress-bar').attr('aria-valuemax') - $('.progress-bar').attr('aria-valuemin'));
          $('.progress-bar').css('width', siz+'%');
        }
      }
      else if (worksDid == worksTotal) {
        $('.progress-bar').attr('aria-valuenow', worksDid);
        $('.progress-bar').css('width', '100%');
        console.log("set 100%");
      }
    }, 1000);

    var newTips = [];
    var xTips = [];

    var iOldTips = 1;
    var iTips = 1;

    var run = false;

    setInterval( function() {
      var i;
      for( i = 0; i < 1000; i++) {
        if(run && iOldTips < oldtips.length) {
         if (tips.indexOf(oldtips[iOldTips]) === -1) {
           xTips.push(oldtips[iOldTips]);
         }
         iOldTips++;
        }

        if(run && iTips < tips.length) {
         if (oldtips.indexOf(tips[iTips]) === -1) {
           newTips.push(tips[iTips]);
         }
         iTips++;
        }
      }
    }, 2000);

    setInterval( function() {
      if(iTips == tips.length && iOldTips == oldtips.length) {
        var d = new Date();
        $('#status').append("Time: " + d + " worksTotal: " + worksTotal + " worksDid: " + worksDid + " xTips: " + xTips.length + " newTips: " + newTips.length + " nTips: " + tips.length + "<br/>");

        var tmp = [];
        tmp = xTips.concat(newTips);
        work = work.concat(tmp);
        worksTotal += tmp.length;
        $('.progress-bar').attr('aria-valuemax', worksTotal);

        xTips = [];
        newTips = [];
      }

      sendRequest(getTips, function(data) {
         console.log("Got tx: " + JSON.stringify(data));

         run = false;
         oldtips = tips;
         tips = data.hashes;
         iOldTips = 0;
         iTips = 0;
         run = true;
      });
    }, 150000);
});

</script>

<!-- Menu -->
<nav class="navbar navbar-default navbar-inverse navbar-static-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">tangleTools</a>
    </div>
    <ul class="nav navbar-nav">
      <li><a href="#" id="play"><span class="glyphicon glyphicon-play"></span></a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
      	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="glyphicon glyphicon-cog"></span></a>
      	<ul class="dropdown-menu">
      	  <li><a href="#settings" data-toggle="modal">Settings...</a></li>
      	</ul>
      </li>
    </ul>
  </div>
</nav>

<div class="container-fluid" style="background-color:white;">
  <div class="progress">
    <div class="progress-bar" aria-valuemin="0" aria-valuemax="1000" aria-valuenow="1" role="progressbar" style="width:0.1%">
    </div>
  </div>
</div>

<div class="container-fluid" style="background-color:white;">
  <ul class="pager">
   <li><a href="#" class="prev">Previous</a></li>
   <li><span id="pointer"></span></li>
   <li><a href="#" class="next">Next</a></li>
  </ul>
</div>

<div class="container-fluid" style="background-color:white;">
  <div class="col-sm-3" style="background-color:white;">
  </div>
  <div class="col-sm-6" style="background-color:white;">
    <p id="status"></p>
  </div>
  <div class="col-sm-6" style="background-color:white;">
  </div>
</div>

<!-- Content -->
<div class="container-fluid" style="background-color:white;">
  <div class="row">
    <div class="col-sm-12" style="background-color:#bbbbbb;">
      <table id="maintable"></table>
    </div>
  </div>

     <!-- Footer -->
  <div class="row">
    <div class="col-sm-5" style="background-color:white;">
    </div>
    <div class="col-sm-2" style="background-color:white;">
       <p>Programmed by ifinta. See my <a href="http://github.com/ifinta">github</a> repositories also.</p>
    </div>
    <div class="col-sm-5" style="background-color:white;">
    </div>
  </div>
</div>

<!-- Modal: show transactions... -->
<div class="modal fade" role="dialog" id="showtransaction">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal">&times;</button>
      	<h4 class="modal-title">Details:</h4>
      </div>
      <div class="modal-body">
        <form role="form">
      	  <div class="form-group">
      	    <label for="comment">Tx JSON:</label>
      	    <textarea id="showtxcontent" class="form-control" rows="30"></textarea>
      	  </div>
      	</form>
      </div>
      <div class="modal-footer">
	       <button type="button" class="btn btn-default" data-dismiss="modal" id="savebutton">Ok</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal settings...-->
<div class="modal fade" role="dialog" id="settings">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal">&times;</button>
      	<h4 class="modal-title">Settings</h4>
      </div>
      <div class="modal-body">
      	<form role="form">
      	</form>
      </div>
      <div class="modal-footer">
	       <button type="button" class="btn btn-default" data-dismiss="modal" id="setbutton">Set</button>
      </div>
    </div>

  </div>
</div>

</body>
</html>
