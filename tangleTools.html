<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Programmed by ifinta -->
  <title>tangleTools</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <style>
  th, td {
      padding: 5px;
  }

  tr.a:nth-child(even) {
    background-color: #ddd;
  }

  tr.b:nth-child(even) {
    background-color: #fff;
  }

  #showtransaction .modal-dialog
  {
    width: 1000px;
  }

  #txapproval .modal-dialog
  {
    width: 800px;
  }

  table, td
  {
    border: 1px solid black;
  }

  .modal-backdrop
  {
    opacity:0.6 !important;
  }
  </style>

<body>

</head>

<script>

var pleaseWait = " Please wait!";
var started = false;
var pause = false;

var work = [];
var bundles = new Map();
var transactions = new Map();

var worksDid = 0;
var worksTotal = 0;

function sendRequest(requestData, callback) {
  var url = "http://127.0.0.1:14265";
  console.log( "Sending an request to " + url + " with data " + JSON.stringify(requestData) );
  var request = new XMLHttpRequest();
  request.open("POST", url);
  request.onreadystatechange = function() {
    if (this.readyState == 4) {
      var json = JSON.parse(this.responseText);
      if (json.exception) {
        console.log(json.exception);
      } else if (json.error) {
        console.log(json.error);
      } else {
        callback(json);
      }
    }
  };
  request.send(JSON.stringify(requestData));
}

$(document).ready(function(){
    $("#pause").hide();
    $("#startexplore").show();

    $("#pause").click( function(e){
      $('#status').html("Known tasks: " + worksTotal + " Tasks did: " + worksDid + " Number of tips: " + tips.length + " PAUSE");
      e.preventDefault();
      $("#pause").hide();
      $("#startexplore").show();
      pause = true;
      return false;
    });

    $(document).on("click", "#trytoapprove", function(e){
    });

    $(document).on("click", "#clearall", function(e){
      $('#maintable').html("");
    });

    var getTips = {
        'command': 'getTips'
    }

    $(document).on("click", "#startexplore", function(e){
      $('#status').html("Known tasks: " + worksTotal + " Tasks did: " + worksDid + " Number of tips: " + tips.length);
      $("#pause").show();
      $("#startexplore").hide();
      pause = false;
      if(!started) {
        started = true;
        $('.progress-bar').attr('aria-valuemin', 0);
        $('.progress-bar').attr('aria-valuemax', 1000);
        $('.progress-bar').attr('aria-valuenow', 0);
        $('.progress-bar').css('width', '0.1%');
        $('#progressbar').toggle();

        var d = new Date();
        $('#status').html("Known tasks: " + worksTotal + " Tasks did: " + worksDid + " Getting tips..." + pleaseWait);

        sendRequest(getTips, function(data) {
           console.log("Got tx: " + JSON.stringify(data));
           tips = data.hashes;
           var d = new Date();
           $('#status').html("Known tasks: " + worksTotal + " Tasks did: " + worksDid + " Number of tips: " + data.hashes.length + " Getting second set of tips..." + pleaseWait);
        });
      }
    });

    $(document).on("click", ".leg", function(e){
      var tail = this.id;
      var obj = $(this);
      console.log("id: " + tail);

      var getBundle = {
        'command': 'getBundle',
        'transaction': tail
      }

      sendRequest(getBundle, function(data) {
        console.log("Got bundle: " + JSON.stringify(data));

        var getTrytes = {
          'command': 'getTrytes',
          'hashes': []
        }

        $.each(data.transactions, function(i, item) {
          getTrytes.hashes.push(item.hash);
        });

        var wrongbundle = "";

        if(getTrytes.hashes.length == 0) {
          console.log("Wrong bundle: " + tail);
          var wrongbundle = "WRONG!!!!: ";
          getTrytes.hashes.push(tail);
        }

        sendRequest(getTrytes, function(trytes) {
           console.log("Got trytes: " + JSON.stringify(trytes));

           var analyzeTransactions = {
             'command': 'analyzeTransactions',
             'trytes': trytes.trytes
           }

           sendRequest(analyzeTransactions, function(analyze) {
             console.log("Analyze trytes: " + JSON.stringify(analyze));

             var item = analyze.transactions[analyze.transactions.length - 1];

             var newhtml = '<table><tr><td colspan="2">' + wrongbundle + showtx(tail, 10) + '<br/>';
             var i;
             for(i = 1; i < analyze.transactions.length; i++) {
               console.log("More txs in one bundle: " + tail);
               newhtml = newhtml + showtx(analyze.transactions[i].hash, 10) + '<br/>';
             }
             newhtml = newhtml + '</td></tr><tr><td>' + showleg(item.approvedTrunkTransaction, 10) + '</td><td>' + showleg(item.approvedBranchTransaction, 10) + '</td></tr></table>';
             console.log("newhtml: " + newhtml);
             obj.parent().html(newhtml);
           });
         });
       });
    });

    $(document).on("click", ".tx", function () {

      var getTrytes = {
        'command': 'getTrytes',
        'hashes': []
      }

      getTrytes.hashes.push(this.id);

      sendRequest(getTrytes, function(trytes) {
         console.log("Got tx trytes: " + JSON.stringify(trytes));

         var analyzeTransactions = {
           'command': 'analyzeTransactions',
           'trytes': trytes.trytes
         }

         sendRequest(analyzeTransactions, function(analyze) {
           console.log("Analyze tx trytes: " + JSON.stringify(analyze));
           $("#showtxcontent").text(JSON.stringify(analyze.transactions[0]));
         });
      });
    });

    function showleg(hash, n) {
      var result = '<a href="#" class="leg" id="' + hash + '">';
      if(n == 0)
        result = result + hash;
      else
        result = result + hash.substring(0, n) + "...";
      return result + '</a>';
    };

    function showtx(hash, n) {
      var result = '<a href="#showtransaction" data-toggle="modal" class="tx" id="' + hash + '">';
      if(n == 0)
        result = result + hash;
      else
        result = result + hash.substring(0, n) + "...";
      return result + '</a>';
    };

    setInterval(function(){
      if(!pause && work.length > 0) {

        var tail = work.shift();

        var knownTx = transactions.has(tail);
        if(!knownTx) {
          var getBundle = {
            'command': 'getBundle',
            'transaction': tail
          }

          sendRequest(getBundle, function(data) {
            console.log("Got bundle: " + JSON.stringify(data));

             var getTrytes = {
               'command': 'getTrytes',
               'hashes': []
             }

             $.each(data.transactions, function(i, item) {
               var knownTx = transactions.has(item.hash);
               if(!knownTx)
                getTrytes.hashes.push(item.hash);
               else
                console.log("known tx... not for analyze: " + item.hash);
             });

             if(getTrytes.hashes.length > 0) {
               bundles.set(getBundle.tail, { 'hashes': getTrytes.hashes });
             } else {
               getTrytes.hashes.push(tail);
             }

             sendRequest(getTrytes, function(trytes) {
                console.log("Got trytes: " + JSON.stringify(trytes));

                var analyzeTransactions = {
                  'command': 'analyzeTransactions',
                  'trytes': trytes.trytes
                }

                sendRequest(analyzeTransactions, function(analyze) {
                  console.log("Analyze trytes: " + JSON.stringify(analyze));

                  $.each(analyze.transactions, function(i, item) {
                    transactions.set(item.hash, item);
                    work.push(item.approvedTrunkTransaction);
                    work.push(item.approvedBranchTransaction);
                    worksTotal+=2;
                  });

                  console.log("unknownn bundle registered....");
                  worksDid++;
                  if(pleaseWait ==""  && worksDid != 0) {
                    $('.progress-bar').attr('aria-valuemax', worksTotal);
                    $('.progress-bar').attr('aria-valuenow', worksDid);
                    var siz = (worksDid-$('.progress-bar').attr('aria-valuemin'))*100/($('.progress-bar').attr('aria-valuemax') - $('.progress-bar').attr('aria-valuemin'));
                    $('.progress-bar').css('width', siz+'%');
                  }
                });
             });
          });
        } else {
          console.log("known tail... dropped: " + tail);
          worksDid++;
          if(pleaseWait ==""  && worksDid != 0) {
            $('.progress-bar').attr('aria-valuenow', worksDid);
            var siz = (worksDid-$('.progress-bar').attr('aria-valuemin'))*100/($('.progress-bar').attr('aria-valuemax') - $('.progress-bar').attr('aria-valuemin'));
            $('.progress-bar').css('width', siz+'%');
          }
        }
      }
      else if (!pause && worksDid == worksTotal) {
        if(pleaseWait ==""  && worksDid != 0) {
          $('.progress-bar').attr('aria-valuenow', worksDid);
          $('.progress-bar').css('width', '100%');
          console.log("set 100%");
        }
      }

      if(!pause && pleaseWait == "")
        $('#status').html("Known tasks: " + worksTotal + " Tasks did: " + worksDid + " Number of tips: " + tips.length + " Exploring the Tangle...");
    }, 1000);

    var oldtips = [];
    var tips = [];

    var newTips = [];
    var xTips = [];

    var iOldTips = 1;
    var iTips = 1;

    var run = false;

    setInterval( function() {
      var i;
      for( i = 0; i < 1000; i++) {
        if(run && iOldTips < oldtips.length) {
         if (tips.indexOf(oldtips[iOldTips]) === -1) {
           xTips.push(oldtips[iOldTips]);
         }
         iOldTips++;
        }

        if(run && iTips < tips.length) {
         if (oldtips.indexOf(tips[iTips]) === -1) {
           newTips.push(tips[iTips]);
         }
         iTips++;
        }
      }
    }, 2000);

    setInterval( function() {
      if(!pause && iTips == tips.length && iOldTips == oldtips.length) {
        var d = new Date();

        var row = '<table><tr><td colspan="2">' + "Time: " + d + " Number of tips: " + tips.length + "</td></tr>";
        row = row + "<tr><td>" + "Removed tips: " + xTips.length + "</td><td>";

        if(xTips.length > 0) {
          row = row + "<table><tr>";

          $.each( xTips, function(i, tip){
            row = row + "<td>" + showleg(tip, 10) + "</td>";
          });

          row = row + "</tr></table>";
        }

        row = row + "</td></tr>";

        row = row + "<tr><td>" + "New tips: " + newTips.length + "</td><td>";

        if(newTips.length > 0) {
          row = row + "<table><tr>";

          $.each( newTips, function(i, tip){
            row = row + "<td>" + showleg(tip, 10) + "</td>";
          });

          row = row + "</tr></table>";
        }

        row = row + "</td></tr></table>";

        $('#maintable').html( row + "<br/>" + $('#maintable').html());

        var tmp = [];
        tmp = xTips.concat(newTips);
        work = work.concat(tmp);
        worksTotal += tmp.length;
        if(pleaseWait =="" && worksDid != 0)
          $('.progress-bar').attr('aria-valuemax', worksTotal);

        xTips = [];
        newTips = [];

        var d = new Date();
        $('#status').html("Known tasks: " + worksTotal + " Tasks did: " + worksDid + " Number of tips: " + tips.length + " Getting tips...");
        pleaseWait = "";
      }

      if(started && !pause){
        sendRequest(getTips, function(data) {
           console.log("Got tx: " + JSON.stringify(data));
           var d = new Date();
           $('#status').html("Known tasks: " + worksTotal + " Tasks did: " + worksDid + " Number of tips: " + data.hashes.length + " Start comparing..." + pleaseWait);

           run = false;
           oldtips = tips;
           tips = data.hashes;
           iOldTips = 0;
           iTips = 0;
           run = true;
        });
      }
    }, 150000);
});

</script>

<!-- Menu -->
<nav class="navbar navbar-default navbar-inverse navbar-static-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">tangleTools</a>
    </div>
    <ul class="nav navbar-nav">
      <li><a href="#" id="startexplore"><span class="glyphicon glyphicon-play"></span></a></li>
      <li><a href="#" id="pause"><span class="glyphicon glyphicon-pause"></span></a></li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Actions
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="#" id="clearall">Clear log</a></li>
          <li><a href="#txapproval" data-toggle="modal">Try to approve transfers</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Analyze
        <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href="#todo" data-toggle="modal">Bundle or Tx...</a></li>
          <li><a href="#todo" data-toggle="modal">Tips...</a></li>
          <li><a href="#todo" data-toggle="modal">Known Tangle...</a></li>
        </ul>
      </li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
      	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="glyphicon glyphicon-cog"></span></a>
      	<ul class="dropdown-menu">
      	  <li><a href="#settings" data-toggle="modal">Settings...</a></li>
      	</ul>
      </li>
    </ul>
  </div>
</nav>

<div class="container-fluid" style="background-color:white;display:none" id="progressbar">
  <h3>Exploring the Tangle...</h3>
  <div class="progress">
    <div class="progress-bar" aria-valuemin="0" aria-valuemax="1000" aria-valuenow="1" role="progressbar" style="width:0.1%">
    </div>
  </div>
</div>

<div class="container-fluid" style="background-color:white;">
  <div class="col-sm-12" style="background-color:white;">
    <p id="status"></p>
  </div>
</div>
<!-- Content -->
<div class="container-fluid" style="background-color:white;">
  <div class="row">
    <div class="col-sm-12" style="background-color:#bbbbbb;">
      <table id="maintable" class="tangle">
      </table>
    </div>
  </div>

  <!-- Footer -->
  <div class="row">
    <div class="col-sm-3" style="background-color:white;">
    </div>
    <div class="col-sm-6" style="background-color:white;">
       <p>Idee, design and programming by ifinta. Copyright 2016 by ifinta. The source of the page published under GPL licence. See my <a href="http://github.com/ifinta/tangleTools" target="_blank">github</a> repository.</p>
       <p>Remarks:</p>
       <p>- the idee for the feature "Try to approve transfers" coming from Jimmy Xiong</p>
       <h3>Donations:</h3>
       <p>IOTA: LGQQTNJFXAZRAOWVEAZQ9EMRVVPPFYQKKONUVTLFXAJQ9HJU9AHMSXLQYQEEXBLNIBLRAQTKGUEMSRTENKZDFQJZQH</p>
       <p>BTC: 1FiNTaXmmHDasJUhgkSo5U79uuQN7c5pB5</p>
    </div>
    <div class="col-sm-3" style="background-color:white;">
    </div>
  </div>
</div>

<!-- Modal: show transactions... -->
<div class="modal fade" role="dialog" id="showtransaction">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal">&times;</button>
      	<h4 class="modal-title">Details:</h4>
      </div>
      <div class="modal-body">
        <form role="form">
      	  <div class="form-group">
      	    <label for="comment">Tx JSON:</label>
      	    <textarea id="showtxcontent" class="form-control" rows="30"></textarea>
      	  </div>
      	</form>
      </div>
      <div class="modal-footer">
	       <button type="button" class="btn btn-default" data-dismiss="modal" id="savebutton">Ok</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: settings...-->
<div class="modal fade" role="dialog" id="settings">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal">&times;</button>
      	<h4 class="modal-title">Settings</h4>
      </div>
      <div class="modal-body">
        <form role="form">
          <div class="checkbox">
            <label><input type="checkbox">Don't add spams to log</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
	       <button type="button" class="btn btn-default" data-dismiss="modal" id="setbutton">Set</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Try to approve a transfer...-->
<div class="modal fade" role="dialog" id="txapproval">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal">&times;</button>
      	<h4 class="modal-title">Try to approve transfers</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" role="form">
          <div class="form-group">
            <label class="control-label col-sm-2" for="transfera">Tx id A:</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="transfera" placeholder="Enter your transfer hash">
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-2" for="transferb">Tx id B:</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="transferb" placeholder="Enter your transfer hash">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
	       <button type="button" class="btn btn-default" data-dismiss="modal" id="trytoapprove">Try to approve</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: not yet implemented...-->
<div class="modal fade" role="dialog" id="todo">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal">&times;</button>
      	<h4 class="modal-title">Info</h4>
      </div>
      <div class="modal-body">
        <p>Sorry. This feature does not yet implemented...</p>
      </div>
      <div class="modal-footer">
	       <button type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
