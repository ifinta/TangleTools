<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Programmed by ifinta -->
  <title>tangleTools</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <style>
  th, td {
      padding: 5px;
  }

  tr.a:nth-child(even) {
    background-color: #ddd;
  }

  tr.b:nth-child(even) {
    background-color: #fff;
  }

  #showtransaction .modal-dialog
  {
    width: 1000px;
  }

  table, td
  {
    border: 1px solid black;
  }
  </style>

<body>

</head>

<script>

function sendRequest(requestData, callback) {
  var url = "http://127.0.0.1:14265";
  console.log( "Sending an request to " + url + " with data " + JSON.stringify(requestData) );
  var request = new XMLHttpRequest();
  request.open("POST", url);
  request.onreadystatechange = function() {
    if (this.readyState == 4) {
      var json = JSON.parse(this.responseText);
      if (json.exception) {
        console.log(json.exception);
      } else if (json.error) {
        console.log(json.error);
      } else {
        callback(json);
      }
    }
  };
  request.send(JSON.stringify(requestData));
}

$(document).ready(function(){
    var getTips = {
        'command': 'getTips'
    }

    var d = new Date();
    $('#status').html("Time: " + d + " Getting tips... Please wait!");

    sendRequest(getTips, function(data) {
       console.log("Got tx: " + JSON.stringify(data));
       tips = data.hashes;
       var d = new Date();
       $('#status').html("Time: " + d + " nTips: " + data.hashes.length + " Getting second set of tips... Please wait!");
    });

    $(document).on("click", ".leg", function(e){
      var tail = this.id;
      var obj = $(this);
      console.log("id: " + tail);

      var getBundle = {
        'command': 'getBundle',
        'transaction': tail
      }

      sendRequest(getBundle, function(data) {
        console.log("Got bundle: " + JSON.stringify(data));

        var getTrytes = {
          'command': 'getTrytes',
          'hashes': []
        }

        $.each(data.transactions, function(i, item) {
          getTrytes.hashes.push(item.hash);
        });

        var wrongbundle = "";

        if(getTrytes.hashes.length == 0) {
          console.log("Wrong bundle: " + tail);
          var wrongbundle = "WRONG!!!!: ";
          getTrytes.hashes.push(tail);
        }

        sendRequest(getTrytes, function(trytes) {
           console.log("Got trytes: " + JSON.stringify(trytes));

           var analyzeTransactions = {
             'command': 'analyzeTransactions',
             'trytes': trytes.trytes
           }

           sendRequest(analyzeTransactions, function(analyze) {
             console.log("Analyze trytes: " + JSON.stringify(analyze));

             var item = analyze.transactions[analyze.transactions.length - 1];

             var newhtml = '<table><tr><td colspan="2">' + wrongbundle + showtx(tail, 10) + '<br/>';
             var i;
             for(i = 1; i < analyze.transactions.length; i++) {
               console.log("More txs in one bundle: " + tail);
               newhtml = newhtml + showtx(analyze.transactions[i].hash, 10) + '<br/>';
             }
             newhtml = newhtml + '</td></tr><tr><td>' + showleg(item.approvedTrunkTransaction, 10) + '</td><td>' + showleg(item.approvedBranchTransaction, 10) + '</td></tr></table>';
             console.log("newhtml: " + newhtml);
             obj.parent().html(newhtml);
           });
         });
       });
    });

    $(document).on("click", ".tx", function () {

      var getTrytes = {
        'command': 'getTrytes',
        'hashes': []
      }

      getTrytes.hashes.push(this.id);

      sendRequest(getTrytes, function(trytes) {
         console.log("Got tx trytes: " + JSON.stringify(trytes));

         var analyzeTransactions = {
           'command': 'analyzeTransactions',
           'trytes': trytes.trytes
         }

         sendRequest(analyzeTransactions, function(analyze) {
           console.log("Analyze tx trytes: " + JSON.stringify(analyze));
           $("#showtxcontent").text(JSON.stringify(analyze.transactions[0]));
         });
      });
    });

    function showleg(hash, n) {
      var result = '<a href="#" class="leg" id="' + hash + '">';
      if(n == 0)
        result = result + hash;
      else
        result = result + hash.substring(0, n) + "...";
      return result + '</a>';
    };

    function showtx(hash, n) {
      var result = '<a href="#showtransaction" data-toggle="modal" class="tx" id="' + hash + '">';
      if(n == 0)
        result = result + hash;
      else
        result = result + hash.substring(0, n) + "...";
      return result + '</a>';
    };

    var oldtips = [];
    var tips = [];

    var newTips = [];
    var xTips = [];

    var iOldTips = 1;
    var iTips = 1;

    var run = false;

    setInterval( function() {
      var i;
      for( i = 0; i < 1000; i++) {
        if(run && iOldTips < oldtips.length) {
         if (tips.indexOf(oldtips[iOldTips]) === -1) {
           xTips.push(oldtips[iOldTips]);
         }
         iOldTips++;
        }

        if(run && iTips < tips.length) {
         if (oldtips.indexOf(tips[iTips]) === -1) {
           newTips.push(tips[iTips]);
         }
         iTips++;
        }
      }
    }, 2000);

    setInterval( function() {
      if(iTips == tips.length && iOldTips == oldtips.length) {
        var d = new Date();

        var row = '<table><tr><td colspan="2">' + "Time: " + d + " nTips: " + tips.length + "</td></tr>";
        row = row + "<tr><td>" + "xTips: " + xTips.length + "</td><td>";

        if(xTips.length > 0) {
          row = row + "<table><tr>";

          $.each( xTips, function(i, tip){
            row = row + "<td>" + showleg(tip, 10) + "</td>";
          });

          row = row + "</tr></table>";
        }

        row = row + "</td></tr>";

        row = row + "<tr><td>" + "newTips: " + newTips.length + "</td><td>";

        if(newTips.length > 0) {
          row = row + "<table><tr>";

          $.each( newTips, function(i, tip){
            row = row + "<td>" + showleg(tip, 10) + "</td>";
          });

          row = row + "</tr></table>";
        }

        row = row + "</td></tr></table>";

        $('#maintable').html( row + "<br/>" + $('#maintable').html());

        xTips = [];
        newTips = [];

        var d = new Date();
        $('#status').html("Time: " + d + " nTips: " + tips.length + " Getting tips...");
      }

      sendRequest(getTips, function(data) {
         console.log("Got tx: " + JSON.stringify(data));
         var d = new Date();
         $('#status').html("Time: " + d + " nTips: " + data.hashes.length + " Comparing it... Please wait!");

         run = false;
         oldtips = tips;
         tips = data.hashes;
         iOldTips = 0;
         iTips = 0;
         run = true;
      });
    }, 150000);
});

</script>

<!-- Menu -->
<nav class="navbar navbar-default navbar-inverse navbar-static-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">tangleTools</a>
    </div>
  </div>
</nav>

<div class="container-fluid" style="background-color:white;">
  <div class="col-sm-12" style="background-color:white;">
    <p id="status"></p>
  </div>
</div>
<!-- Content -->
<div class="container-fluid" style="background-color:white;">
  <div class="row">
    <div class="col-sm-12" style="background-color:#bbbbbb;">
      <table id="maintable" class="tangle">
      </table>
    </div>
  </div>

  <!-- Footer -->
  <div class="row">
    <div class="col-sm-3" style="background-color:white;">
    </div>
    <div class="col-sm-6" style="background-color:white;">
       <p>Programmed by ifinta. See my <a href="http://github.com/ifinta" target="_blank">github</a> repositories also.</p>
       <h3>Donations:</h3>
       <p>IOTA: LGQQTNJFXAZRAOWVEAZQ9EMRVVPPFYQKKONUVTLFXAJQ9HJU9AHMSXLQYQEEXBLNIBLRAQTKGUEMSRTENKZDFQJZQH</p>
       <p>BTC: 1FiNTaXmmHDasJUhgkSo5U79uuQN7c5pB5</p>
    </div>
    <div class="col-sm-3" style="background-color:white;">
    </div>
  </div>
</div>

<!-- Modal: show transactions... -->
<div class="modal fade" role="dialog" id="showtransaction">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal">&times;</button>
      	<h4 class="modal-title">Details:</h4>
      </div>
      <div class="modal-body">
        <form role="form">
      	  <div class="form-group">
      	    <label for="comment">Tx JSON:</label>
      	    <textarea id="showtxcontent" class="form-control" rows="30"></textarea>
      	  </div>
      	</form>
      </div>
      <div class="modal-footer">
	       <button type="button" class="btn btn-default" data-dismiss="modal" id="savebutton">Ok</button>
      </div>
    </div>

  </div>
</div>

</body>
</html>
